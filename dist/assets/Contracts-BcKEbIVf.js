import{r as n,l as Q,m as W,n as J,j as e,o as X,p as G,q as H}from"./main-DVAXFARq.js";import{s as m}from"./toast-DASUAV0i.js";import{u as K}from"./useTranslation-LM3aqFs0.js";import{P as Y}from"./plus-CLAC8xEl.js";import{F as $,C as Z}from"./file-text-DTrgQsIn.js";import{T as ee}from"./trending-up-BktgYemw.js";import{C as P}from"./check-Ddl6_53K.js";import{D as se}from"./dollar-sign-B5DZ-WZI.js";import{S as te,X as O}from"./x-BNAztCrf.js";import{c as ae}from"./createLucideIcon-Cp5FBxft.js";import{S as re}from"./square-pen--FR5X-jv.js";import"./modulepreload-polyfill-B5Qt9EMX.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],le=ae("ellipsis-vertical",ce),ge=()=>{const{t}=K(),[x,T]=n.useState([]),[N,A]=n.useState([]),[b,j]=n.useState(!0),[d,f]=n.useState("all"),[g,I]=n.useState(""),[R,p]=n.useState(!1),[i,k]=n.useState(null),[v,u]=n.useState(null),[r,l]=n.useState({deviceId:"",customerName:"",customerEmail:"",customerPhone:"",customerDocument:"",dailyRate:3e4,contractDays:500,startDate:new Date().toISOString().split("T")[0],notes:"",devicePin:"",freeDaysLimit:4,initialFee:0,exemptFromCutOff:!1}),[h,M]=n.useState(null);n.useEffect(()=>{D(),B(),z();const s=a=>{v&&!a.target.closest(".action-menu-container")&&u(null)};return document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[d,v]);const z=async()=>{try{const s=await Q();s.success&&M(s.data)}catch(s){console.error("Error loading company settings:",s)}},D=async()=>{j(!0);try{const s=await W();s.success?T(s.contracts||[]):console.error("Failed to fetch contracts:",s.error)}catch(s){console.error("Error loading contracts:",s)}finally{j(!1)}},B=async()=>{try{const s=await J();s.success&&A(s.devices||[])}catch(s){console.error("Error loading devices:",s)}},q=()=>{k(null);const s=(h==null?void 0:h.contractDefaults)||{};l({deviceId:"",customerName:"",customerEmail:"",customerPhone:"",customerDocument:"",dailyRate:s.dailyRate||3e4,contractDays:s.contractDays||500,startDate:new Date().toISOString().split("T")[0],notes:"",devicePin:Math.floor(1e3+Math.random()*9e3).toString(),freeDaysLimit:s.freeDaysLimit||4,initialFee:s.initialFee||0,exemptFromCutOff:!1}),p(!0)},w=s=>{k(s),l({deviceId:s.deviceId,customerName:s.customerName||"",customerEmail:s.customerEmail||"",customerPhone:s.customerPhone||"",customerDocument:s.customerDocument||"",dailyRate:s.dailyRate,contractDays:s.contractDays,startDate:s.startDate,notes:s.notes||"",devicePin:"",freeDaysLimit:s.freeDaysLimit||4,exemptFromCutOff:s.exemptFromCutOff||!1}),p(!0)},V=async s=>{s.preventDefault(),j(!0);try{const a=i?await G(i.contractId,r):await H(r);a.success?(p(!1),D(),m(t(i?"contracts.modal.successUpdate":"contracts.modal.successCreate"),"success")):m(`Error: ${a.error}`,"error")}catch(a){console.error("Error saving contract:",a),m(t("contracts.modal.errorSave"),"error")}finally{j(!1)}},S=async(s,a)=>{if(window.confirm(t("contracts.card.statusConfirm",{status:a})))try{const c=await X(s,a);c.success?(D(),m(t("contracts.modal.successUpdate"),"success")):m(`Error: ${c.error}`,"error")}catch(c){console.error("Error updating status:",c),m(t("common.error"),"error")}},y=s=>`$${s.toLocaleString()} COP`,E=s=>({ACTIVE:"#00C292",COMPLETED:"#03C9D7",CANCELLED:"#EF4444",SUSPENDED:"#FB9678"})[s]||"#6B7280",F=x.filter(s=>{var a,c;if(d!=="all"&&s.status.toLowerCase()!==d.toLowerCase())return!1;if(g){const o=g.toLowerCase();return s.deviceId.toLowerCase().includes(o)||s.contractId.toLowerCase().includes(o)||((a=s.customerName)==null?void 0:a.toLowerCase().includes(o))||((c=s.customerEmail)==null?void 0:c.toLowerCase().includes(o))}return!0}),C=({title:s,value:a,icon:c,color:o})=>e.jsxs("div",{className:"contract-stat-card",children:[e.jsx("div",{className:"stat-icon",style:{background:o},children:e.jsx(c,{size:20})}),e.jsxs("div",{className:"stat-info",children:[e.jsx("div",{className:"stat-label",children:s}),e.jsx("div",{className:"stat-number",children:a})]})]});return e.jsxs("div",{className:"contracts-page",children:[e.jsxs("div",{className:"page-header",children:[e.jsxs("div",{children:[e.jsxs("h1",{children:["ðŸ“‹ ",t("contracts.title")]}),e.jsx("p",{children:t("contracts.subtitle")})]}),e.jsxs("button",{className:"btn-primary",onClick:q,children:[e.jsx(Y,{})," ",t("contracts.newContract")]})]}),e.jsxs("div",{className:"contracts-stats",children:[e.jsx(C,{title:t("contracts.stats.total"),value:x.length,icon:$,color:"#03C9D7"}),e.jsx(C,{title:t("contracts.stats.active"),value:x.filter(s=>s.status==="ACTIVE").length,icon:ee,color:"#00C292"}),e.jsx(C,{title:t("contracts.stats.completed"),value:x.filter(s=>s.status==="COMPLETED").length,icon:P,color:"#7460EE"}),e.jsx(C,{title:t("contracts.stats.totalValue"),value:y(x.reduce((s,a)=>s+a.totalAmount,0)),icon:se,color:"#FB9678"})]}),e.jsxs("div",{className:"contracts-filters",children:[e.jsx("button",{className:`filter-btn ${d==="all"?"active":""}`,onClick:()=>f("all"),children:t("contracts.filters.all")}),e.jsx("button",{className:`filter-btn ${d==="active"?"active":""}`,onClick:()=>f("active"),children:t("contracts.filters.active")}),e.jsx("button",{className:`filter-btn ${d==="completed"?"active":""}`,onClick:()=>f("completed"),children:t("contracts.filters.completed")}),e.jsx("button",{className:`filter-btn ${d==="cancelled"?"active":""}`,onClick:()=>f("cancelled"),children:t("contracts.filters.cancelled")}),e.jsxs("div",{className:"search-box",children:[e.jsx(te,{className:"search-icon"}),e.jsx("input",{type:"text",placeholder:t("contracts.searchPlaceholder"),value:g,onChange:s=>I(s.target.value)}),g&&e.jsx("button",{className:"clear-search",onClick:()=>I(""),"aria-label":"Clear search",children:e.jsx(O,{})})]})]}),e.jsx("div",{className:"contracts-list",children:b?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:t("contracts.loading")})]}):F.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx($,{size:48}),e.jsx("h3",{children:t("contracts.empty.title")}),e.jsx("p",{children:t("contracts.empty.subtitle")})]}):F.map(s=>e.jsx("div",{className:"contract-card",children:e.jsxs("div",{className:"contract-body",onClick:a=>{a.stopPropagation(),w(s),u(null)},children:[e.jsxs("div",{className:"contract-info-grid",children:[e.jsxs("div",{className:"contract-title",children:[e.jsx("h3",{children:s.deviceIdName||s.deviceId}),e.jsx("a",{onClick:a=>{a.stopPropagation()},href:`/p/${s.deviceIdName||s.deviceId}`,target:"_blank",rel:"noopener noreferrer",className:"text-gray-900 hover:text-indigo-600 transition-colors",title:"Open Payment Page",children:e.jsx("span",{className:"status-badge",style:{background:`${E(s.status)}20`,color:E(s.status)},children:t(`common.${s.status.toLowerCase()}`,s.status)})})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:t("contracts.card.customer")}),e.jsx("span",{className:"info-value",children:s.customerName||"N/A"})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:t("contracts.card.dailyRate")}),e.jsx("span",{className:"info-value",children:y(s.dailyRate)})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:t("contracts.card.totalDays")}),e.jsxs("span",{className:"info-value",children:[s.contractDays," dÃ­as"]})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:t("contracts.card.totalAmount")}),e.jsx("span",{className:"info-value",children:y(s.totalAmount)})]}),e.jsx("div",{className:"info-item action-menu-wrapper",children:e.jsxs("div",{className:"action-menu-container",children:[e.jsx("button",{className:`action-menu-btn ${v===s.contractId?"active":""}`,onClick:a=>{a.stopPropagation(),u(v===s.contractId?null:s.contractId)},children:e.jsx(le,{size:20})}),v===s.contractId&&e.jsxs("div",{className:"action-menu-dropdown",children:[e.jsxs("button",{onClick:()=>{w(s),u(null)},children:[e.jsx(re,{size:16})," ",t("contracts.card.edit")]}),s.status==="ACTIVE"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{S(s.contractId,"COMPLETED"),u(null)},children:[e.jsx(P,{size:16})," ",t("contracts.card.complete")]}),e.jsxs("button",{className:"text-danger",onClick:()=>{S(s.contractId,"CANCELLED"),u(null)},children:[e.jsx(O,{size:16})," ",t("contracts.card.cancel")]})]})]})]})})]}),e.jsxs("div",{className:"contract-progress",children:[e.jsxs("div",{className:"progress-header",children:[e.jsx("span",{children:t("contracts.card.progress",{paid:s.paidDays,total:s.contractDays})}),e.jsxs("span",{className:"progress-percent",children:[(s.paidDays/s.contractDays*100).toFixed(1),"%"]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${s.paidDays/s.contractDays*100}%`,background:E(s.status)}})}),e.jsxs("div",{className:"progress-details",children:[e.jsxs("div",{children:[e.jsx(P,{size:14}),t("contracts.card.paid")," ",y(s.paidAmount)]}),e.jsxs("div",{children:[e.jsx(Z,{size:14}),s.startDate," â†’ ",s.endDate]})]})]})]})},s.contractId))}),R&&e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal-content",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:t(i?"contracts.modal.editTitle":"contracts.modal.addTitle")}),e.jsx("button",{className:"modal-close",onClick:()=>p(!1),children:"Ã—"})]}),e.jsxs("form",{onSubmit:V,className:"contract-form",children:[e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:t("contracts.modal.deviceId")}),i?e.jsx("input",{type:"text",value:r.deviceId,disabled:!0}):e.jsx(e.Fragment,{children:e.jsxs("select",{value:r.deviceId,onChange:s=>{var L;const a=s.target.value;console.log(a),console.log(N);const c=N.find(_=>_.deviceId===a*1);console.log(c);const o=((L=h==null?void 0:h.contractDefaults)==null?void 0:L.emailDomain)||"pocketbike.app",U=c&&c.name?`${c.name.trim()}@${o}`.toLowerCase():"";l({...r,deviceId:a,customerEmail:U})},required:!0,children:[e.jsx("option",{value:"",children:t("contracts.modal.selectDevice")}),N.filter(s=>!s.hasActiveContract).map(s=>e.jsx("option",{value:s.deviceId,children:s.name||""},s.deviceId))]})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:t("contracts.modal.startDate")}),e.jsx("input",{type:"date",value:r.startDate,onChange:s=>l({...r,startDate:s.target.value}),required:!0,disabled:i})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:t("contracts.modal.customerPhone")}),e.jsx("input",{type:"tel",inputMode:"numeric",placeholder:"300 756 0069",value:r.customerPhone,onChange:s=>l(a=>{const c=s.target.value.replace(/\D/g,"").slice(0,10),o=c.length>6?`${c.slice(0,3)} ${c.slice(3,6)} ${c.slice(6)}`:c.length>3?`${c.slice(0,3)} ${c.slice(3)}`:c;return{...a,customerPhone:o}})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:t("contracts.modal.devicePin")}),e.jsx("input",{type:"text",value:r.devicePin,onChange:s=>l({...r,devicePin:s.target.value}),placeholder:t("contracts.modal.devicePin"),maxLength:"4",className:"font-mono",required:!i}),e.jsxs("div",{className:"phone-pin-checkbox",children:[e.jsx("input",{type:"checkbox",id:"usePhonePin",style:{marginRight:"0.5rem",width:"auto"},onChange:s=>{if(s.target.checked){const c=(r.customerPhone||"").replace(/\D/g,"");c.length>=4?l(o=>({...o,devicePin:c.slice(-4)})):(m(t("contracts.modal.usePhonePinError"),"error"),s.target.checked=!1)}}}),e.jsx("label",{htmlFor:"usePhonePin",style:{fontSize:"0.6rem",color:"#4B5563",cursor:"pointer"},children:t("contracts.modal.usePhonePin")})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:t("contracts.modal.customerName")}),e.jsx("input",{type:"text",value:r.customerName,onChange:s=>l({...r,customerName:s.target.value}),placeholder:"John Doe"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:t("contracts.modal.customerEmail")}),e.jsx("input",{type:"email",value:r.customerEmail,onChange:s=>l({...r,customerEmail:s.target.value}),placeholder:"cliente@email.com"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:t("contracts.modal.customerDocument")}),e.jsx("input",{type:"text",value:r.customerDocument,onChange:s=>l({...r,customerDocument:s.target.value}),placeholder:t("contracts.modal.customerDocumentPlaceholder")})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:t("contracts.modal.dailyRateCop")}),e.jsx("input",{type:"text",value:new Intl.NumberFormat("es-CO",{style:"currency",currency:"COP",minimumFractionDigits:0}).format(r.dailyRate),onChange:s=>{const a=parseInt(s.target.value.replace(/\D/g,""),10)||0;l({...r,dailyRate:a})},placeholder:"$ 30.000"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:t("contracts.modal.contractDays")}),e.jsx("input",{type:"number",value:r.contractDays,onChange:s=>l({...r,contractDays:parseInt(s.target.value)}),min:"1",max:"1000"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:t("contracts.modal.initialFeeCop")}),e.jsx("input",{type:"text",value:r.initialFee?new Intl.NumberFormat("es-CO",{style:"currency",currency:"COP",minimumFractionDigits:0}).format(r.initialFee):"",onChange:s=>{const a=parseInt(s.target.value.replace(/\D/g,""),10)||0;l({...r,initialFee:a})},placeholder:"$ 0",disabled:i})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:t("contracts.modal.freeDaysMonth")}),e.jsx("input",{type:"number",value:r.freeDaysLimit,onChange:s=>l({...r,freeDaysLimit:parseInt(s.target.value)}),min:"0",max:"31"})]}),e.jsx("div",{className:"form-group",style:{gridColumn:"1 / -1"},children:e.jsxs("div",{className:"phone-pin-checkbox",style:{marginTop:"0.5rem",padding:"10px",borderRadius:"8px"},children:[e.jsx("input",{type:"checkbox",id:"exemptFromCutOff",checked:r.exemptFromCutOff,onChange:s=>l({...r,exemptFromCutOff:s.target.checked}),style:{marginRight:"0.5rem",width:"auto"}}),e.jsx("label",{htmlFor:"exemptFromCutOff",style:{fontSize:"0.7rem",cursor:"pointer",fontWeight:"600"},children:t("contracts.modal.exemptCutoff")})]})})]}),e.jsxs("div",{className:"form-group full-width",children:[e.jsx("label",{children:t("contracts.modal.notes")}),e.jsx("textarea",{value:r.notes,onChange:s=>l({...r,notes:s.target.value}),rows:"3",placeholder:t("contracts.modal.notesPlaceholder")})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:()=>p(!1),children:t("contracts.modal.cancelBtn")}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:b,children:t(b?"contracts.modal.savingBtn":i?"contracts.modal.updateBtn":"contracts.modal.createBtn")})]})]})]})})]})};export{ge as default};
