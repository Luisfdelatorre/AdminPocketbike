import"./modulepreload-polyfill-B5Qt9EMX.js";const S=window.location.origin;class b{constructor(e){this.baseURL=e,this.requestInterceptors=[]}addRequestInterceptor(e){this.requestInterceptors.push(e)}async request(e,n={}){let t={...n,url:e};for(const c of this.requestInterceptors)t=await c(t);const s=`${this.baseURL}${t.url}`,a={method:t.method||"GET",headers:t.headers||{},body:t.body},o=await fetch(s,a),r=o.ok?await o.json():null;if(!o.ok){const c=new Error(`HTTP ${o.status}`);throw c.response={status:o.status,statusText:o.statusText,data:r||{error:o.statusText}},c}return{data:r,status:o.status,statusText:o.statusText,headers:o.headers}}get(e){return this.request(e,{method:"GET"})}post(e,n){return this.request(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}}const v=new b(S);v.addRequestInterceptor(d=>{const e=sessionStorage.getItem("paymentAuthToken");return e&&(d.headers=d.headers||{},d.headers.Authorization=`Bearer ${e}`),d});const D=(d,e)=>v.post("/apinode/auth/pin-login",{deviceIdName:d,pin:e}),T=()=>v.get("/apinode/payments/status"),P=()=>v.get("/apinode/payments/history"),R=()=>v.post("/apinode/payments/use-free-day"),N=()=>v.post("/apinode/payments/request-loan"),O=d=>v.post("/apinode/payments/request",d),A=d=>{const e=sessionStorage.getItem("paymentAuthToken"),n=`/apinode/payments/stream/${d}?token=${e}`;return new EventSource(n)},_=()=>v.get("/apinode/payments/device-status"),w={MODAL:{FREE_DAY_TITLE:"¬øDesea usar un d√≠a libre para pagar su factura pendiente?",FREE_DAY_CONFIRM:"S√≠, usar d√≠a libre",LOAN_TITLE:"¬øDeseas solicitar un pr√©stamo para trabajar hoy y pagar m√°s tarde? Se crear√° una deuda que deber√°s pagar.",LOAN_CONFIRM:"S√≠, solicitar pr√©stamo",CANCEL:"Cancelar"},BUTTONS:{FREE_DAY:"Usar D√≠a Libre",LOAN:"Pr√©stamo",PAY_NOW:"Pagar Ahora",MORE_OPTIONS:"M√°s formas de pago",LOGOUT:"Cerrar Sesi√≥n",LOGIN:"Iniciar Sesi√≥n",PROCESSING:"Procesando..."},SUCCESS:{FREE_DAY_APPLIED:"¬°D√≠a libre aplicado con √©xito! Tu dispositivo se est√° reactivando.",LOAN_APPLIED:"¬°Pr√©stamo aplicado con √©xito! Tu dispositivo se est√° reactivando. Recuerda que debes pagar m√°s tarde.",PAYMENT_SUCCESS:"Pago procesado exitosamente",LOGIN_SUCCESS:"Inicio de sesi√≥n exitoso"},ERRORS:{FREE_DAY_ERROR:"Error al aplicar d√≠a libre",LOAN_ERROR:"Error al solicitar pr√©stamo",PAYMENT_ERROR:"Error al procesar el pago",LOGIN_ERROR:"Error de autenticaci√≥n",AUTH_FAILED:"Autenticaci√≥n fallida",NO_FREE_DAYS:"No tienes d√≠as libres disponibles",PENDING_INVOICE:"Ya tienes una factura pendiente.",NETWORK_ERROR:"Error de conexi√≥n. Por favor intenta de nuevo.",INVALID_PHONE:"N√∫mero celular inv√°lido",INVALID_AMOUNT:"Monto inv√°lido",PAYMENT_INIT_ERROR:"Error al iniciar el pago con Nequi",PAYMENT_TIMEOUT:"El tiempo de espera del pago ha terminado",MISSING_CREDENTIALS:"Por favor ingresa la placa y el PIN",INVALID_PIN_LENGTH:"El PIN debe ser de 4 d√≠gitos"},STATUS:{PAID:"Pagado",PENDING:"Pendiente",FREE:"Gratis",LOAN:"Pr√©stamo",DEBT:"Deuda",VERIFYING:"Verificando",CONFIRMING:"Confirmando",REQUESTING_PAYMENT:"Solicitando pago a Nequi...",WAITING_NEQUI:"Por favor acepta la notificaci√≥n en tu celular..."},PAYMENT_SCREEN:{TITLE:"Payment App",DEVICE_LABEL:"Dispositivo:",AMOUNT_LABEL:"Monto a pagar:",FREE_DAYS_LABEL:"D√≠as libres disponibles:",PHONE_PLACEHOLDER:"Ingresa tu n√∫mero Nequi",PAYMENT_HISTORY:"Historial de Pagos",NO_HISTORY:"No hay historial de pagos"}},u={get:d=>{const e=d.split(".");let n=w;for(const t of e)if(n=n==null?void 0:n[t],n===void 0)return console.warn(`Message not found: ${d}`),`[${d}]`;return n}},E={confirmationModal:`
    <div id="confirmationModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-handle"></div>
            <span class="close-modal">&times;</span>
            <p>¬øDesea usar un d√≠a libre para pagar su factura pendiente?</p>
            <div class="modal-actions">
                <button id="confirmPaymentBtn" class="btn btn-primary">S√≠, usar d√≠a libre</button>
                <button id="cancelPaymentBtn" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>`,pendingPaymentReminder:`
    <div class="important-reminder hidden" id="pendingPaymentReminder">
        <div class="reminder-icon">‚è≥</div>
        <div class="reminder-content">
            <div class="reminder-title">Pago pendiente detectado</div>
            <div class="reminder-text">
                <div><strong>Referencia:</strong> <span id="pendingPaymentRef">-</span></div>
                <div><strong>Monto:</strong> $<span id="pendingPaymentAmount">-</span> COP</div>
                <div><strong>Iniciado:</strong> <span id="pendingPaymentTime">-</span></div>
                <div class="progress-container">
                    <div class="progress-bar-animated"></div>
                </div>
                <div class="reminder-note" id="paymentStatusLabelReminder">Reanudando verificaci√≥n autom√°ticamente...</div>
            </div>
        </div>
    </div>`,moreOptionsSection:`
    <div id="moreOptionsSection" class="more-options-section">
        <div class="action-buttons">
            <div class="btn-wrapper">
                <span id="freeDaysCount" class="badge-circle">1</span>
                <button id="useFreeDayBtn" class="btn btn-success">
                    <span class="btn-text">Usar d√≠a libre</span>
                </button>
            </div>
            <button id="loanBtn" class="btn btn-secondary">Pr√©stamo</button>
        </div>
        <div class="payment-history payment-history-scroll">
            <table>
                <thead>
                    <tr>
                        <th>D√≠a</th>
                        <th>Cantidad</th>
                        <th>Nequi</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>
    </div>`,loadingScreen:`
<div id="loadingScreen" class="screen">
    <div class="container">
        <div class="loading-content">
            <h2 class="app-title">Pago a PocketBike</h2>
            <p class="loading-message" id="loadingMessage">MTJ17H - Mensajer√≠a</p>
            <p class="text-center">
                <img alt="PocketBike Logo" src="/pocketbike_60x60.jpg" class="img-lg">
            </p>
            <div class="amount-display">
                <div class="amount-value" id="loadingAmount"><span class="text-black">COP</span></div>
            </div>

            <div class="progress-container">
                <div class="progress-bar-animated"></div>
            </div>

            <div class="important-reminder">
                <div class="reminder-icon">üîî</div>
                <div class="reminder-content">
                    <div class="reminder-title" id="paymentStatusLabelLoading">Solicitando pago por Wompi...</div>
                    <div class="reminder-text">Recuerda completar tu transacci√≥n en el centro de notificaciones de Nequi.
                    </div>
                </div>
            </div>

            <div class="nequi-guide">
                <div class="screenshots-container">
                    <div class="screenshot-card">
                        <div class="screenshot-number">1</div>
                        <img src="/notification1.jpg" alt="Notificaci√≥n 1" class="img-full">
                    </div>
                    <div class="screenshot-card">
                        <div class="screenshot-number">2</div>
                        <img src="/notification2.jpg" alt="Notificaci√≥n 2" class="img-full">
                    </div>
                </div>
            </div>

            <button class="finish-btn" id="finishBtn">Finalizar proceso</button>
        </div>
    </div>
</div>`,successScreen:`
<div id="successScreen" class="screen">
    <div class="container">
        <div class="success-card">
            <div class="receipt-header">
                <img alt="PocketBike Logo" src="/pocketbike_60x60.jpg" class="receipt-logo">
                <h3 class="receipt-title">POCKETBIKE</h3>
                <p class="text-muted receipt-subtitle">Comprobante de Pago</p>
            </div>

            <div class="status-badge-wrapper">
                <div class="status-badge">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2e7d32" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    <span class="status-badge-text">PAGO EXITOSO</span>
                </div>
            </div>

            <div class="transaction-details">
                <div class="detail-row detail-row-spaced">
                    <span class="detail-label">Veh√≠culo</span>
                    <span class="detail-value-device" id="successDeviceId">--</span>
                </div>
                <div class="detail-row detail-row-spaced">
                    <span class="detail-label">Fecha y hora</span>
                    <span class="detail-value-date" id="paymentDate">--</span>
                </div>
                <div class="detail-row detail-row-spaced">
                    <span class="detail-label">Referencia</span>
                    <span class="detail-value-ref" id="successReference">--</span>
                </div>
                <div class="detail-row detail-row-spaced">
                    <span class="detail-label">Factura</span>
                    <span class="detail-value-ref" id="successInvoice">--</span>
                </div>

                <div class="total-box">
                    <div class="detail-row">
                        <span class="total-label">TOTAL PAGADO</span>
                        <span class="total-value" id="successAmount">$30,000 COP</span>
                    </div>
                </div>
            </div>

            <div class="receipt-footer">
                <p class="thank-you-message">¬°Gracias por su pago!</p>
                <p class="text-muted security-note">Procesado de forma segura por <strong>Wompi</strong></p>
                <button class="finish-btn" id="doneBtn">Finalizar</button>
            </div>
        </div>
    </div>
</div>`};let y={TIMEZONE:"America/Bogota",MAX_TIMEOUT:2700*1e3,PIN_LENGTH:4,PHONE_LENGTH:10,PROGRESS_WARNING:75,PROGRESS_CRITICAL:90,DRAG_THRESHOLD:100,TRANSITION_DURATION:500};const B={PAID:"status-paid",FREE:"status-free",FREEPASS:"status-free",VERIFYING:"status-verifying",CONFIRMING:"status-verifying",PENDING:"status-pending",DEBT:"status-pending",LOAN:"status-loan",DECLINED:"status-rejected",ERROR:"status-rejected",VOIDED:"status-rejected"},i={authToken:null,paymentData:null,currentPin:"",fromLogin:!1,eventSource:null};class M{constructor(){this.elements={},this.isInitialized=!1}initialize(){var e;this.isInitialized||(this.loadTemplates(),this.elements.screens={login:document.getElementById("loginScreen"),loading:document.getElementById("loadingScreen"),payment:document.getElementById("paymentScreen"),success:document.getElementById("successScreen")},this.elements.inputs={deviceId:document.getElementById("deviceId"),pin:document.getElementById("devicePin"),phone:document.getElementById("phoneNumber")},this.elements.buttons={nequiPay:document.getElementById("nequiPayBtn"),freeDay:document.getElementById("useFreeDayBtn"),loan:document.getElementById("loanBtn"),logout:document.getElementById("logoutBtn"),morePayment:document.getElementById("morePaymentOptions"),confirm:document.getElementById("confirmPaymentBtn"),cancel:document.getElementById("cancelPaymentBtn"),done:document.getElementById("doneBtn")},this.elements.displays={deviceId:document.getElementById("deviceIdDisplay"),device:document.getElementById("deviceDisplay"),paymentAmount:document.getElementById("paymentAmount"),paymentDueDate:document.getElementById("paymentDueDate"),freeDaysCount:document.getElementById("freeDaysCount"),loginError:document.getElementById("loginError")},this.elements.loading={message:document.getElementById("loadingMessage"),amount:document.getElementById("loadingAmount"),statusLabel:document.getElementById("paymentStatusLabelLoading"),progressBar:document.querySelector("#loadingScreen .progress-bar-animated")},this.elements.pendingPayment={container:document.getElementById("pendingPaymentReminder"),reference:document.getElementById("pendingPaymentRef"),amount:document.getElementById("pendingPaymentAmount"),time:document.getElementById("pendingPaymentTime"),statusLabel:document.getElementById("paymentStatusLabelReminder"),progressBar:(e=document.getElementById("pendingPaymentReminder"))==null?void 0:e.querySelector(".progress-bar-animated"),normal:document.getElementById("normalReminder")},this.elements.sections={moreOptions:document.getElementById("moreOptionsSection"),payment:document.getElementById("paymentSection")},this.elements.tables={historyBody:document.getElementById("historyTableBody")},this.elements.modal={confirmation:document.getElementById("confirmationModal"),text:document.querySelector("#confirmationModal p"),close:document.querySelector(".close-modal")},this.elements.keypad={buttons:document.querySelectorAll(".keypad-btn:not(.empty)"),pinBoxes:document.querySelectorAll(".pin-box"),clear:document.getElementById("keypadClear"),backspace:document.getElementById("keypadBackspace"),logo:document.querySelector(".device-header img")},this.elements.success={deviceId:document.getElementById("successDeviceId"),reference:document.getElementById("successReference"),date:document.getElementById("paymentDate"),amount:document.getElementById("successAmount"),invoice:document.getElementById("successInvoice")},this.isInitialized=!0)}loadTemplates(){if(console.log("Loading templates..."),document.getElementById("confirmationModal")||document.body.insertAdjacentHTML("beforeend",E.confirmationModal),document.getElementById("loadingScreen")||document.body.insertAdjacentHTML("beforeend",E.loadingScreen),document.getElementById("successScreen")||document.body.insertAdjacentHTML("beforeend",E.successScreen),document.getElementById("paymentSection")){if(!document.getElementById("pendingPaymentReminder")){const n=document.getElementById("normalReminder");n&&n.insertAdjacentHTML("afterend",E.pendingPaymentReminder)}if(!document.getElementById("moreOptionsSection")){const n=document.getElementById("pendingPaymentReminder");n&&n.insertAdjacentHTML("afterend",E.moreOptionsSection)}}}get(e){const n=e.split(".");let t=this.elements;for(const s of n)t=t==null?void 0:t[s];return t}}class l{static showToast(e,n="error"){const t=document.querySelector(".toast-notification");t&&t.remove();const s=document.createElement("div");s.className=`toast-notification ${n}`,s.textContent=e,document.body.appendChild(s),s.offsetHeight,s.classList.add("show"),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),300)},3e3)}static showError(e){this.showToast(e,"error")}static formatMoney(e){return e?new Intl.NumberFormat("es-CO",{minimumFractionDigits:0,maximumFractionDigits:0}).format(e):"0"}static formatPhone(e){return e?e.replace(/\D/g,"").replace(/(\d{3})(\d{3})(\d{4})/,"$1 $2 $3"):""}static formatDate(e){const n=new Date(e),t=new Intl.DateTimeFormat("es-CO",{timeZone:"UTC",day:"numeric",month:"numeric"}).formatToParts(n),s=t.find(c=>c.type==="day").value,a=t.find(c=>c.type==="month").value,o=parseInt(a)-1;return`${s} ${["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"][o]}`}static formatDateTime(e,n=!1){const t=new Date(e),s=new Intl.DateTimeFormat("en-US",{timeZone:y.TIMEZONE,day:"numeric",month:"numeric",hour:"numeric",minute:"numeric",hour12:!0}).formatToParts(t),a=s.find(f=>f.type==="day").value,o=s.find(f=>f.type==="month").value,r=s.find(f=>f.type==="hour").value,c=s.find(f=>f.type==="minute").value,p=s.find(f=>f.type==="dayPeriod").value.toLowerCase(),g=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"][parseInt(o)-1],h=`${a} ${g}`,I=`${r}:${c}${p}`;return n?`${h} ${I}`:`<div class="fecha-pago"><div class="fecha">${h}</div><div class="hora">${I}</div></div>`}static updateDeviceStatusUI(e){const n=document.getElementById("deviceStatusRing"),t=document.getElementById("batteryStatusSvg"),s=document.getElementById("motorStatusSvg");if(n&&(n.classList.remove("online","offline"),e.online?n.classList.add("online"):(n.classList.add("offline"),t.classList.remove("high","medium","low"),s.classList.remove("red","green"))),s&&(s.classList.remove("red","green"),e.cutOff?s.classList.add("red"):e.ignition?s.classList.add("green"):s.classList.remove("red","green")),t&&e.batteryLevel!==void 0){const a=e.batteryLevel;t.classList.remove("high","medium","low"),a>60?t.classList.add("high"):a>20?t.classList.add("medium"):t.classList.add("low")}}}class k{constructor(e){this.dom=e}updateDisplay(){const e=this.dom.get("keypad.pinBoxes");if(!e)return;const n=i.currentPin.length;e.forEach((t,s)=>{s<n?(t.value="",t.classList.add("filled")):(t.value="",t.classList.remove("filled")),s===n?t.classList.add("active"):t.classList.remove("active")})}addDigit(e){return i.currentPin.length<y.PIN_LENGTH&&(i.currentPin+=e,this.updateDisplay(),i.currentPin.length===y.PIN_LENGTH)}removeDigit(){i.currentPin.length>0&&(i.currentPin=i.currentPin.slice(0,-1),this.updateDisplay())}clear(){i.currentPin="",this.updateDisplay()}getValue(){return i.currentPin}}class C{constructor(e){this.dom=e}switchScreen(e,n="forward"){const t=this.dom.elements.screens,s=Object.values(t).find(r=>r==null?void 0:r.classList.contains("active"));if(e.style.display="",s&&(s.style.display=""),!s){e.classList.add("active");return}if(s===e)return;e.classList.add("active"),e.style.visibility="visible",e.style.position="absolute",s.style.position="absolute",s.style.transition="transform 0.4s ease",e.style.transition="transform 0.4s ease";const a=n==="forward"?"100%":"-100%",o=n==="forward"?"-100%":"100%";s.style.transform="translateX(0)",e.style.transform=`translateX(${a})`,s.offsetHeight,e.offsetHeight,s.style.transform=`translateX(${o})`,e.style.transform="translateX(0)",setTimeout(()=>{s.classList.remove("active"),s.style.visibility="",s.style.position="",s.style.transform="",s.style.transition="",s.style.display="",e.style.position="relative",e.style.transition="",e.style.display=""},y.TRANSITION_DURATION)}}class x{constructor(e){this.dom=e,this.dragInitialized=!1}async show(e,n){const t=this.dom.get("modal.confirmation"),s=this.dom.get("modal.text");if(t)return s.textContent=u.get(e),this.dom.get("buttons.confirm").textContent=u.get(n),t.classList.remove("hidden"),t.style.display="flex",t.offsetWidth,t.classList.add("active"),console.log("Modal show"),new Promise(a=>{const o=()=>{t.classList.remove("active"),setTimeout(()=>{t.style.display="none",t.classList.add("hidden");const g=t.querySelector(".modal-content");g&&(g.style.transform="")},300),this.dom.get("buttons.confirm").onclick=null,this.dom.get("buttons.cancel").onclick=null;const m=this.dom.get("modal.close");m&&(m.onclick=null),window.onclick=null},r=()=>{o(),a(!0)},c=()=>{o(),a(!1)};this.dom.get("buttons.confirm").onclick=r,this.dom.get("buttons.cancel").onclick=c;const p=this.dom.get("modal.close");p&&(p.onclick=c),window.onclick=m=>{m.target===t&&c()},this._setupDrag(t,c)})}_setupDrag(e,n){const t=e.querySelector(".modal-content");if(!t||t.dataset.dragInitialized)return;t.dataset.dragInitialized="true";let s=0,a=0,o=!1;t.addEventListener("touchstart",r=>{t.scrollTop>0||(s=r.touches[0].clientY,o=!0,t.style.transition="none")},{passive:!0}),t.addEventListener("touchmove",r=>{if(!o)return;a=r.touches[0].clientY;const c=a-s;c>0&&(r.preventDefault(),t.style.transform=`translateY(${c}px)`)},{passive:!1}),t.addEventListener("touchend",()=>{if(!o)return;o=!1,t.style.transition="",a-s>y.DRAG_THRESHOLD?n():t.style.transform="",s=0,a=0})}}class F{constructor(e,n,t){this.dom=e,this.screen=n,this.modal=t}async loadData(e=!1,n=null){var t,s;try{if(n)i.paymentData=n;else{const m=await T();i.paymentData=m.data}console.log("Loading data",i.paymentData);const a=this.dom,o=a.get("displays.device");o.textContent=i.paymentData.deviceIdName,o.classList.remove("text-muted"),o.classList.add("text-primary");const r=a.get("displays.paymentDueDate");r.classList.add("text-muted"),r.textContent="   ",i.paymentData.pendingInvoiceDate&&(r.textContent=l.formatDate(i.paymentData.pendingInvoiceDate),i.paymentData.isOverdue?(r.classList.remove("text-muted"),r.classList.add("text-danger"),(t=a.get("displays.paymentAmount"))!=null&&t.parentElement&&a.get("displays.paymentAmount").parentElement.classList.add("text-danger")):(r.classList.remove("text-danger"),(s=a.get("displays.paymentAmount"))!=null&&s.parentElement&&a.get("displays.paymentAmount").parentElement.classList.remove("text-danger"))),console.log(i.paymentData),a.get("displays.paymentAmount").textContent=l.formatMoney(i.paymentData.dailyRate),a.get("inputs.phone").value=l.formatPhone(i.paymentData.customerPhone);const c=i.paymentData.freeDaysAvailable||0,p=a.get("displays.freeDaysCount");if(p&&(p.textContent=c,p.style.display=c>0?"block":"none",p.textContent=c,p.style.display=c>0?"block":"none"),i.paymentData.pendingPayment&&i.paymentData.pendingPayment.reference){console.log("‚úÖ Found pending payment, resuming monitoring");const m=a.get("pendingPayment.container"),g=a.get("pendingPayment.normal");m&&g&&(a.get("pendingPayment.reference").textContent=i.paymentData.pendingPayment.reference,a.get("pendingPayment.amount").textContent=l.formatMoney(i.paymentData.pendingPayment.amount),a.get("pendingPayment.time").textContent=l.formatDateTime(i.paymentData.pendingPayment.createdAt,!0),this._updatePendingProgress(i.paymentData.pendingPayment.createdAt),m.dataset.shouldShow="true",g.dataset.shouldShow="false",m.classList.remove("hidden"),m.style.display="flex",g.style.display="none");const h=a.get("loading.amount");h&&(h.textContent=`$${l.formatMoney(i.paymentData.pendingPayment.amount)} COP`),this.monitorStatus(i.paymentData.pendingPayment.transactionId)}else{const m=a.get("pendingPayment.container"),g=a.get("pendingPayment.normal"),h=a.get("sections.moreOptions"),I=h==null?void 0:h.classList.contains("expanded");m&&g&&(m.dataset.shouldShow="false",g.dataset.shouldShow="true",m.style.display="none",g.style.display=I?"none":"flex")}try{setTimeout(()=>this.loadHistory(),0),setTimeout(async()=>{try{const m=await _();l.updateDeviceStatusUI(m.data)}catch{}},0)}catch(m){console.warn("Failed to load device status",m)}}catch(a){console.error("Error loading payment data:",a),this.logout()}}async loadHistory(){try{const e=await P();this.renderHistory(e.data.history)}catch(e){console.error("Load history error:",e);const n=this.dom.get("tables.historyBody");n&&(n.innerHTML='<tr><td colspan="4" style="text-align: center;">Error al cargar historial</td></tr>')}}renderHistory(e){const n=this.dom.get("tables.historyBody");if(n){if(!e||e.length===0){n.innerHTML='<tr><td colspan="4" style="text-align: center;">Sin historial de pagos</td></tr>';return}n.innerHTML=e.map(t=>{const s=B[t.dayType]||"status-pending";return`
            <tr>
                <td>${l.formatDate(t.date)}</td>
                <td>$${l.formatMoney(t.paidAmount)}</td>
                <td class="no-padding">${t.paymentDate?l.formatDateTime(t.paymentDate):"---"}</td>
                <td class="${s} no-padding">${t.status}</td>
            </tr>
            `}).join("")}}logout(){i.authToken=null,i.paymentData=null,sessionStorage.removeItem("paymentAuthToken");const e=this.dom.get("inputs.deviceId"),n=this.dom.get("displays.deviceId"),t=this._getDeviceIdFromUrl();t?(e.style.display="none",n&&(n.textContent=t,n.style.display="block")):(e.value="",e.disabled=!1,e.style.display="block",n&&(n.style.display="none"));const s=this.dom.get("displays.loginError");s&&(s.textContent=""),this.screen.switchScreen(this.dom.get("screens.login"),"back")}_getDeviceIdFromUrl(){const n=window.location.pathname.match(/\/pagos\/([^\/]+)/);return n?n[1]:null}_updatePendingProgress(e){const n=this.dom.get("pendingPayment.progressBar");if(!n)return;const t=new Date(e).getTime(),a=Date.now()-t,o=Math.min(100,Math.max(0,a/y.MAX_TIMEOUT*100));n.style.width=`${o}%`,o>y.PROGRESS_CRITICAL?n.style.background="linear-gradient(90deg, #dc2626 0%, #991b1b 100%)":o>y.PROGRESS_WARNING&&(n.style.background="linear-gradient(90deg, #ea580c 0%, #c2410c 100%)")}async processNequi(){var a,o,r,c;const e=this.dom.get("inputs.phone").value.replace(/\D/g,""),n=this.dom.get("displays.paymentAmount").textContent.replace(/\D/g,""),t=parseInt(n,10);if(!e||e.length!==y.PHONE_LENGTH){l.showError(u.get("ERRORS.INVALID_PHONE"));return}if(!t||t<=0){l.showError(u.get("ERRORS.INVALID_AMOUNT"));return}await this._updateLoadingScreen(t),this.screen.switchScreen(this.dom.elements.screens.loading);const s=this.dom.get("loading.statusLabel");s&&(s.textContent=u.get("STATUS.REQUESTING_PAYMENT"));try{const m=(await O({phone:e})).data;s&&(s.textContent=u.get("STATUS.WAITING_NEQUI")),await new Promise(g=>setTimeout(g,5e3)),m.paymentData.id?this.monitorStatus(m.paymentData.id):this.screen.switchScreen(this.dom.elements.screens.payment,"back")}catch(p){const m=((o=(a=p.response)==null?void 0:a.data)==null?void 0:o.error)||((c=(r=p.response)==null?void 0:r.data)==null?void 0:c.message)||u.get("ERRORS.PAYMENT_INIT_ERROR");l.showError(m),this.screen.switchScreen(this.dom.elements.screens.payment,"back")}}async processFreeDayRequest(){var t,s;const e=this.dom.get("buttons.freeDay");this.dom.get("displays.freeDaysCount");const n=e.innerHTML;e.disabled=!0,e.classList.add("btn-processing"),e.innerHTML=`${u.get("BUTTONS.PROCESSING")} <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;try{await R()}catch(a){const o=((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.error)||a.message||u.get("ERRORS.FREE_DAY_ERROR");l.showError(o)}finally{e.disabled=!1,e.classList.remove("btn-processing"),e.innerHTML=n,await this.loadData()}}async processLoanRequest(){var t,s;const e=this.dom.get("buttons.loan"),n=e.innerHTML;e.disabled=!0,e.innerHTML=`${u.get("BUTTONS.PROCESSING")} <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;try{const o=(await N()).data;if(o&&o.success===!1){l.showError(o.message||"No puedes solicitar un pr√©stamo en este momento");return}alert(u.get("SUCCESS.LOAN_APPLIED")),await this.loadData()}catch(a){console.error("Loan request failed:",a);const o=((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.error)||a.message||u.get("ERRORS.LOAN_ERROR");l.showError(o)}finally{e.disabled=!1,e.innerHTML=n}}monitorStatus(e){i.eventSource&&i.eventSource.close(),i.eventSource=A(e);let n=5;i.eventSource.onmessage=async t=>{const s=JSON.parse(t.data),a=this.dom.get("loading.progressBar"),o=this.dom.get("pendingPayment.progressBar");s.status==="APPROVED"?n=80:(n+=5,n>100&&(n=5));const r=`${n}%`;if(a&&(a.style.width=r),o&&(o.style.width=r),s.message){const c=this.dom.get("loading.statusLabel"),p=this.dom.get("pendingPayment.statusLabel");c&&(c.textContent=s.message),p&&(p.textContent=s.message)}s.status==="COMPLETED"?await this._handlePaymentSuccess(s):["DECLINED","ERROR","VOIDED"].includes(s.status)?await this._handlePaymentFailure(s):s.status==="TIMEOUT"&&await this._handlePaymentTimeout()},i.eventSource.onerror=t=>{console.error("Stream Error:",t),i.eventSource.close(),i.eventSource=null}}async _updateLoadingScreen(e){var s,a,o;const n=this.dom.get("loading.message"),t=this.dom.get("loading.amount");n&&(n.textContent=((s=i.paymentData)==null?void 0:s.deviceIdName)||"",(a=i.paymentData)!=null&&a.pendingInvoiceDate&&(n.textContent=`${(o=i.paymentData)==null?void 0:o.deviceIdName} -  ${l.formatDate(i.paymentData.pendingInvoiceDate)}`)),t&&(t.innerHTML=`$${l.formatMoney(e)} <span class="text-black">COP</span>`)}async _handlePaymentSuccess(e){var t,s,a,o,r;i.eventSource.close(),i.eventSource=null,this.dom.get("success.deviceId").textContent=((t=e.data)==null?void 0:t.deviceIdName)||"",this.dom.get("success.invoice").textContent=((s=e.data)==null?void 0:s.invoiceId)||"",this.dom.get("success.reference").textContent=((a=e.data)==null?void 0:a.reference)||"",this.dom.get("success.date").textContent=l.formatDate(((o=e.data)==null?void 0:o.finalized_at)||""),this.dom.get("success.amount").textContent=`$${l.formatMoney((r=e.data)==null?void 0:r.amount)} COP`;const n=this.dom.get("buttons.done");n&&(n.onclick=async()=>{this.screen.switchScreen(this.dom.elements.screens.payment,"back"),payment.loadData(!0).catch(c=>{console.warn("loadData failed",c),payment.logout()})}),this.screen.switchScreen(this.dom.elements.screens.success)}async _handlePaymentFailure(e){i.eventSource.close(),i.eventSource=null,l.showError(`El pago fue: ${e.status}`),await this.loadData(),this.screen.switchScreen(this.dom.elements.screens.payment,"back")}async _handlePaymentTimeout(){i.eventSource.close(),i.eventSource=null,l.showError(u.get("ERRORS.PAYMENT_TIMEOUT")),await this.loadData(),this.screen.switchScreen(this.dom.elements.screens.payment,"back")}}class H{constructor(e,n,t,s,a){this.dom=e,this.pinManager=n,this.screen=t,this.modal=s,this.payment=a}setup(){this._setupKeypad(),this._setupPhoneInput(),this._setupButtons(),this._setupFullscreen(),this._setupKeyboardShortcuts()}_setupKeypad(){const e=this.dom.get("keypad.buttons");e&&e.forEach(a=>{a.removeAttribute("disabled"),a.addEventListener("click",()=>{const o=a.dataset.val;this.pinManager.addDigit(o)&&this._handleLogin()})});const n=this.dom.get("keypad.clear");n&&(n.removeAttribute("disabled"),n.addEventListener("click",()=>this.pinManager.clear()));const t=this.dom.get("keypad.backspace");t&&(t.removeAttribute("disabled"),t.addEventListener("click",()=>this.pinManager.clear()));const s=this.dom.get("inputs.pin");s&&s.addEventListener("keypress",a=>{a.key==="Enter"&&this._handleLogin()})}_setupPhoneInput(){const e=this.dom.get("inputs.phone");e&&e.addEventListener("input",n=>{let t=n.target.value.replace(/\D/g,"");t.length>y.PHONE_LENGTH&&(t=t.slice(0,y.PHONE_LENGTH)),n.target.value=l.formatPhone(t)})}_setupButtons(){const e=this.dom.get("buttons.nequiPay");e&&e.addEventListener("click",()=>this.payment.processNequi());const n=this.dom.get("buttons.freeDay");n&&n.addEventListener("click",()=>this._handleFreeDay());const t=this.dom.get("buttons.loan");t&&t.addEventListener("click",()=>this._handleLoan());const s=this.dom.get("buttons.logout");s&&s.addEventListener("click",()=>this._handleLogout());const a=this.dom.get("buttons.morePayment");a&&a.addEventListener("click",()=>this._toggleMoreOptions())}_setupFullscreen(){const e=this.dom.get("keypad.logo");e&&e.addEventListener("click",()=>this._toggleFullscreen())}_setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{const n=this.dom.get("screens.login");if(n!=null&&n.classList.contains("active")){if(/\d/.test(e.key)){const t=document.querySelector(`.keypad-btn[data-val="${e.key}"]`);t&&t.click()}e.key==="Backspace"&&this.pinManager.removeDigit()}})}async _handleLogin(){var t,s;const e=this.dom.get("inputs.deviceId").value.trim(),n=this.pinManager.getValue();if(console.log(e,n),!e||!n){l.showError(u.get("ERRORS.MISSING_CREDENTIALS"));return}if(n.length!==y.PIN_LENGTH){l.showError(u.get("ERRORS.INVALID_PIN_LENGTH"));return}try{const o=(await D(e,n)).data;i.authToken=o.token,sessionStorage.setItem("paymentAuthToken",i.authToken),i.fromLogin=!0,this.screen.switchScreen(this.dom.get("screens.payment")),await this.payment.loadData(!1,o.paymentData)}catch(a){const o=((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.error)||a.message||u.get("ERRORS.LOGIN_ERROR");l.showError(o),this.pinManager.clear(),this._shakeAndVibrate()}}async _handleFreeDay(){console.log("Free day clicked");const e=await this.modal.show("MODAL.FREE_DAY_TITLE","MODAL.FREE_DAY_CONFIRM");console.log("Free day confirmed",e),e&&await this.payment.processFreeDayRequest()}async _handleLoan(){console.log("Loan button clicked"),await this.modal.show("MODAL.LOAN_TITLE","MODAL.LOAN_CONFIRM")&&await this.payment.processLoanRequest()}_handleLogout(){this.pinManager.clear(),this.payment.logout()}_toggleMoreOptions(){const e=this.dom.get("sections.moreOptions"),n=this.dom.get("sections.payment"),t=n==null?void 0:n.closest(".container");e==null||e.classList.toggle("expanded"),n==null||n.classList.toggle("compact"),t==null||t.classList.toggle("compact-mode");const s=e==null?void 0:e.classList.contains("expanded");this._updateReminderVisibility(s);const a=this.dom.get("buttons.morePayment");a&&(a.textContent=s?u.get("BUTTONS.MORE_OPTIONS")+" ‚ñ≤":u.get("BUTTONS.MORE_OPTIONS")+" ‚ñº")}_updateReminderVisibility(e){const n=this.dom.get("pendingPayment.container"),t=this.dom.get("pendingPayment.normal");n&&(n.style.display=e?"none":n.dataset.shouldShow==="true"?"flex":"none"),t&&(t.style.display=e?"none":t.dataset.shouldShow==="true"?"flex":"none")}_toggleFullscreen(){const e=document.documentElement,n=e.requestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen||e.msRequestFullscreen,t=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;!document.fullscreenElement&&!document.webkitFullscreenElement&&!document.mozFullScreenElement&&!document.msFullscreenElement?n==null||n.call(e).catch(s=>console.log(`Fullscreen error: ${s.message}`)):t==null||t.call(document)}_shakeAndVibrate(){const e=document.getElementById("pinDisplay");e&&(e.classList.remove("shake"),e.offsetWidth,e.classList.add("shake"),navigator.vibrate&&navigator.vibrate([50,30,50,30,50]),setTimeout(()=>{e.classList.remove("shake")},500))}_getDeviceIdFromUrl(){const n=window.location.pathname.match(/\/pagos\/([^\/]+)/);return n?n[1]:null}}async function L(){const d=new M;d.initialize();const e=new k(d),n=new C(d),t=new x(d),s=new F(d,n,t),a=new H(d,e,n,t,s),o=sessionStorage.getItem("paymentAuthToken");o?(i.authToken=o,n.switchScreen(d.get("screens.payment")),s.loadData(!0).catch(()=>s.logout())):n.switchScreen(d.get("screens.login")),a.setup(),e.updateDisplay()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",L):L();
