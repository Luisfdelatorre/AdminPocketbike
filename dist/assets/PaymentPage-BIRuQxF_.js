import{j as s,r,G as L,H as O,a as z,u as U,I as $,J as H,K as T}from"./main-CfsT50y0.js";import{s as h}from"./toast-DASUAV0i.js";import"./modulepreload-polyfill-B5Qt9EMX.js";function l(a){return(a/100).toLocaleString("es-CO",{minimumFractionDigits:0,maximumFractionDigits:0})}function W(a){return{UNPAID:"‚è≥",PENDING:"‚è≥",PAID:"‚úÖ",APPROVED:"‚úÖ",DECLINED:"‚ùå",ERROR:"‚ùå",FAILED:"‚ùå"}[a]||"‚ùì"}const M=({invoices:a})=>a.length===0?s.jsxs("div",{className:"invoices-card",children:[s.jsxs("div",{className:"card-header",children:[s.jsx("h3",{className:"card-title",children:"üìÑ Unpaid Invoices"}),s.jsx("span",{className:"invoice-count",children:"0"})]}),s.jsxs("div",{className:"empty-state",children:[s.jsx("div",{className:"empty-state-icon",children:"‚úÖ"}),s.jsx("div",{className:"empty-state-text",children:"No unpaid invoices"})]})]}):s.jsxs("div",{className:"invoices-card",children:[s.jsxs("div",{className:"card-header",children:[s.jsx("h3",{className:"card-title",children:"üìÑ Unpaid Invoices"}),s.jsx("span",{className:"invoice-count",children:a.length})]}),s.jsx("div",{className:"invoices-list",children:a.map(t=>s.jsxs("div",{className:"invoice-item",children:[s.jsxs("div",{className:"invoice-info",children:[s.jsxs("div",{className:"invoice-date",children:["üìÖ ",t.date]}),s.jsx("div",{className:"invoice-id",children:t.invoiceId})]}),s.jsx("div",{className:"invoice-amount",children:l(t.amount)}),s.jsx("span",{className:`invoice-status ${t.status.toLowerCase()}`,children:t.status})]},t.invoiceId))})]}),V=({oldestInvoice:a,onPayment:t,paymentStatus:n})=>{const c=a?a.amount:0,i=a!==null;return s.jsxs("div",{className:"payment-card",children:[s.jsxs("div",{className:"payment-header",children:[s.jsx("h3",{className:"card-title",children:"üí∞ Payment"}),s.jsxs("div",{className:"payment-amount",children:[s.jsx("span",{className:"currency",children:"COP $"}),s.jsx("span",{className:"amount",children:l(c)})]})]}),s.jsxs("div",{className:"payment-body",children:[s.jsx("div",{className:"payment-info",children:i?s.jsxs(s.Fragment,{children:[s.jsxs("p",{className:"info-text",children:["üìÖ Oldest unpaid invoice: ",a.date]}),s.jsxs("p",{className:"info-text",children:["üí∞ Amount: ",l(c)," COP"]})]}):s.jsx("p",{className:"info-text",children:"‚úÖ All invoices are paid!"})}),s.jsxs("button",{className:"btn-primary btn-pay",onClick:t,disabled:!i||n!==null,children:[s.jsx("span",{className:"btn-icon",children:"üöÄ"}),s.jsx("span",{className:"btn-text",children:n?"Processing...":"Pay Now"})]})]}),n&&s.jsx("div",{className:"payment-status",children:s.jsxs("div",{className:"status-content",children:[s.jsx("div",{className:"status-icon",children:n.type==="pending"?"‚è≥":n.type==="success"?"‚úÖ":"‚ùå"}),s.jsx("div",{className:"status-message",children:n.message}),s.jsx("div",{className:"status-details",children:n.details})]})})]})},G=({history:a,onRefresh:t})=>s.jsxs("div",{className:"history-card",children:[s.jsxs("div",{className:"card-header",children:[s.jsx("h3",{className:"card-title",children:"üìú Payment History"}),s.jsxs("button",{className:"btn-secondary btn-refresh",onClick:t,children:[s.jsx("span",{className:"btn-icon",children:"üîÑ"}),"Refresh"]})]}),s.jsx("div",{className:"history-list",children:a.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("div",{className:"empty-state-icon",children:"üìú"}),s.jsx("div",{className:"empty-state-text",children:"No payment history"})]}):a.map(n=>{const c=W(n.status),i=n.payment?n.payment.status:n.status;return s.jsxs("div",{className:"history-item",children:[s.jsx("div",{className:"history-icon",children:c}),s.jsxs("div",{className:"history-info",children:[s.jsxs("h4",{children:["üìÖ ",n.date]}),s.jsx("p",{children:n.invoiceId})]}),s.jsxs("div",{className:"history-amount",children:[s.jsx("span",{className:"amount",children:l(n.amount)}),s.jsx("span",{className:"status",children:i})]})]},n.invoiceId)})})]}),J=({deviceId:a})=>{const[t,n]=r.useState(null),[c,i]=r.useState(!0);r.useEffect(()=>{a&&g()},[a]);const g=async()=>{try{const o=await L(a);o.success&&n(o.data)}catch(o){console.error("Error loading contract:",o)}finally{i(!1)}};return c?s.jsx("div",{className:"contract-stats",children:s.jsx("div",{className:"spinner"})}):t?s.jsxs("div",{className:"contract-stats",children:[s.jsxs("div",{className:"card-header",children:[s.jsx("h3",{className:"card-title",children:"üìã Contract Progress"}),s.jsx("span",{className:`status-badge ${t.status.toLowerCase()}`,children:t.status})]}),s.jsxs("div",{className:"progress-section",children:[s.jsx("div",{className:"progress-bar-container",children:s.jsx("div",{className:"progress-bar-fill",style:{width:`${t.completionPercentage}%`},children:s.jsxs("span",{className:"progress-text",children:[t.completionPercentage,"%"]})})}),s.jsxs("div",{className:"progress-info",children:[s.jsxs("span",{children:[t.paidDays," / ",t.totalDays," days paid"]}),s.jsxs("span",{children:[t.remainingDays," days remaining"]})]})]}),s.jsxs("div",{className:"contract-summary",children:[s.jsxs("div",{className:"summary-row",children:[s.jsx("span",{className:"summary-label",children:"Daily Rate:"}),s.jsxs("span",{className:"summary-value",children:[l(t.dailyRate)," COP"]})]}),s.jsxs("div",{className:"summary-row",children:[s.jsx("span",{className:"summary-label",children:"Total Contract:"}),s.jsxs("span",{className:"summary-value",children:[l(t.totalAmount)," COP"]})]}),s.jsxs("div",{className:"summary-row",children:[s.jsx("span",{className:"summary-label",children:"Paid Amount:"}),s.jsxs("span",{className:"summary-value success",children:[l(t.paidAmount)," COP"]})]}),s.jsxs("div",{className:"summary-row",children:[s.jsx("span",{className:"summary-label",children:"Remaining:"}),s.jsxs("span",{className:"summary-value warning",children:[l(t.remainingAmount)," COP"]})]})]}),s.jsxs("div",{className:"contract-dates",children:[s.jsxs("div",{className:"date-item",children:[s.jsx("span",{className:"date-label",children:"Start Date"}),s.jsxs("span",{className:"date-value",children:["üìÖ ",t.startDate]})]}),s.jsxs("div",{className:"date-item",children:[s.jsx("span",{className:"date-label",children:"End Date"}),s.jsxs("span",{className:"date-value",children:["üèÅ ",t.endDate]})]})]}),s.jsx("div",{className:"contract-id",children:s.jsxs("small",{children:["Contract ID: ",t.contractId]})})]}):s.jsx("div",{className:"contract-stats",children:s.jsx("p",{style:{textAlign:"center",color:"#6B7280"},children:"No active contract found"})})},q=()=>{const{deviceId:a}=O(),t=z(),{hasDeviceAccess:n,loginDevice:c,authType:i}=U(),[g,o]=r.useState(!0),[u,w]=r.useState([]),[E,D]=r.useState([]),[C,x]=r.useState(null),[I,P]=r.useState(!1),[d,v]=r.useState(""),[f,y]=r.useState(""),[j,b]=r.useState(!1);r.useEffect(()=>{n(a)?a&&N():P(!0)},[a,i]),r.useEffect(()=>{const e=m=>{const p=m.detail;console.log("Payment update received:",p),p.paymentStatus==="APPROVED"?(h("success","Payment Approved","Your payment was successful!"),setTimeout(()=>{N(),x(null)},3e3)):p.paymentStatus==="DECLINED"&&(h("error","Payment Declined","Payment was not successful"),setTimeout(()=>x(null),3e3))};return window.addEventListener("payment-update",e),()=>{window.removeEventListener("payment-update",e)}},[]);const N=async()=>{o(!0);try{await Promise.all([S(),A()])}catch(e){console.error("Error loading device data:",e),h("error","Loading Error",e.message)}finally{o(!1)}},S=async()=>{try{const e=await $(a);if(!e.success)throw new Error(e.error);w(e.data)}catch(e){console.error("Error loading invoices:",e),h("error","Error","Failed to load invoices")}},A=async()=>{try{const e=await H(a,{limit:20});if(!e.success)throw new Error(e.error);D(e.data)}catch(e){console.error("Error loading history:",e)}},F=async()=>{try{x({type:"pending",message:"Processing...",details:"Creating payment intent..."});const e=await T({deviceId:a,customerEmail:"customer@example.com"});if(!e.success)throw new Error(e.error);const{checkoutUrl:m,payment:p}=e.data;x({type:"pending",message:"Payment Created",details:`Reference: ${p.paymentReference}`}),window.open(m,"_blank"),h("info","Payment Initiated","Complete payment in the new window")}catch(e){console.error("Payment error:",e),h("error","Payment Error",e.message),x(null)}},R=async e=>{if(e.preventDefault(),d.length!==4){y("PIN must be 4 digits");return}b(!0),y("");const m=await c(a,d);m.success?(P(!1),v(""),N()):(y(m.error||"Invalid PIN"),v("")),b(!1)},B=e=>{/^\d*$/.test(e)&&e.length<=4&&(v(e),y(""))};if(I)return s.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0, 0, 0, 0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:s.jsxs("div",{style:{background:"white",borderRadius:"1rem",padding:"2rem",maxWidth:"400px",width:"90%",boxShadow:"0 20px 25px -5px rgba(0, 0, 0, 0.1)"},children:[s.jsx("h2",{style:{color:"#1F2937",marginBottom:"0.5rem",fontSize:"1.5rem"},children:"üîí Enter PIN"}),s.jsxs("p",{style:{color:"#6B7280",marginBottom:"1.5rem"},children:["Please enter the 4-digit PIN for device ",s.jsx("strong",{children:a})]}),s.jsxs("form",{onSubmit:R,children:[s.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",value:d,onChange:e=>B(e.target.value),placeholder:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢",autoFocus:!0,style:{width:"100%",padding:"1rem",fontSize:"2rem",textAlign:"center",letterSpacing:"1rem",border:`2px solid ${f?"#EF4444":"#D1D5DB"}`,borderRadius:"0.5rem",marginBottom:"1rem",color:"#1F2937"}}),f&&s.jsx("p",{style:{color:"#EF4444",fontSize:"0.875rem",marginBottom:"1rem"},children:f}),s.jsx("button",{type:"submit",disabled:j||d.length!==4,style:{width:"100%",padding:"0.75rem",background:j||d.length!==4?"#9CA3AF":"#03C9D7",color:"white",border:"none",borderRadius:"0.5rem",fontSize:"1rem",fontWeight:"600",cursor:j||d.length!==4?"not-allowed":"pointer"},children:j?"Verifying...":"Submit"})]})]})});if(g)return s.jsx("div",{className:"loading",children:s.jsx("div",{className:"spinner"})});const k=u.length>0?u[0]:null;return s.jsx("div",{className:"payment-page-container",children:s.jsxs("div",{className:"payment-section",style:{width:"100%",maxWidth:"1200px",margin:"0 auto"},children:[s.jsx("div",{className:"info-card",style:{marginBottom:"2rem",background:"white",borderRadius:"0.75rem",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0, 0, 0, 0.1)",border:"1px solid #E5E7EB"},children:s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:"1rem"},children:[s.jsxs("div",{children:[s.jsxs("h2",{className:"section-title",style:{marginBottom:"0.5rem",color:"#1F2937",fontSize:"1.5rem",fontWeight:"700"},children:["üèçÔ∏è Device: ",a]}),s.jsxs("p",{style:{color:"#6B7280",fontSize:"0.875rem",margin:0},children:[u.length," unpaid invoice",u.length!==1?"s":""]})]}),i==="admin"&&s.jsx("button",{className:"btn-secondary",onClick:()=>t("/devices"),style:{padding:"0.75rem 1.5rem",background:"#F3F4F6",color:"#1F2937",border:"1px solid #D1D5DB",borderRadius:"0.5rem",fontWeight:"600",cursor:"pointer",transition:"all 0.2s"},onMouseEnter:e=>e.target.style.background="#E5E7EB",onMouseLeave:e=>e.target.style.background="#F3F4F6",children:"‚Üê Back to Devices"})]})}),s.jsx(V,{oldestInvoice:k,onPayment:F,paymentStatus:C}),s.jsx(J,{deviceId:a}),s.jsx(M,{invoices:u}),s.jsx(G,{history:E,onRefresh:N})]})})};export{q as default};
