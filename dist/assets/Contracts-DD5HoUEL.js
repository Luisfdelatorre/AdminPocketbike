import{r as o,l as U,m as _,n as Q,j as e,o as J,p as W,q as X}from"./main-CESdpagL.js";import{s as d}from"./toast-DASUAV0i.js";import{P as H}from"./plus-CQDH23Fc.js";import{F as T}from"./file-text-Bv-pKF8B.js";import{T as K}from"./trending-up-Bk3lXjOh.js";import{C as E}from"./check-BpnIpjOW.js";import{D as Y}from"./dollar-sign-3p03K1Xc.js";import{S as Z,X as F}from"./x-BqA1gSp3.js";import{c as ee}from"./createLucideIcon-BSP4zInn.js";import{S as se}from"./square-pen-BjT_xe_F.js";import{C as ae}from"./calendar-BBapwrek.js";import"./modulepreload-polyfill-B5Qt9EMX.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],re=ee("ellipsis-vertical",te),je=()=>{const[h,$]=o.useState([]),[N,A]=o.useState([]),[y,v]=o.useState(!0),[c,j]=o.useState("all"),[g,I]=o.useState(""),[z,x]=o.useState(!1),[i,P]=o.useState(null),[p,m]=o.useState(null),[t,l]=o.useState({deviceId:"",customerName:"",customerEmail:"",customerPhone:"",customerDocument:"",dailyRate:3e4,contractDays:500,startDate:new Date().toISOString().split("T")[0],notes:"",devicePin:"",freeDaysLimit:4,initialFee:0}),[u,O]=o.useState(null);o.useEffect(()=>{D(),R(),M();const s=a=>{p&&!a.target.closest(".action-menu-container")&&m(null)};return document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[c,p]);const M=async()=>{try{const s=await U();s.success&&O(s.data)}catch(s){console.error("Error loading company settings:",s)}},D=async()=>{v(!0);try{const s=await _();s.success?$(s.contracts||[]):console.error("Failed to fetch contracts:",s.error)}catch(s){console.error("Error loading contracts:",s)}finally{v(!1)}},R=async()=>{try{const s=await Q();s.success&&A(s.devices||[])}catch(s){console.error("Error loading devices:",s)}},q=()=>{P(null);const s=(u==null?void 0:u.contractDefaults)||{};l({deviceId:"",customerName:"",customerEmail:"",customerPhone:"",customerDocument:"",dailyRate:s.dailyRate||3e4,contractDays:s.contractDays||500,startDate:new Date().toISOString().split("T")[0],notes:"",devicePin:Math.floor(1e3+Math.random()*9e3).toString(),freeDaysLimit:s.freeDaysLimit||4,initialFee:s.initialFee||0}),x(!0)},S=s=>{P(s),l({deviceId:s.deviceId,customerName:s.customerName||"",customerEmail:s.customerEmail||"",customerPhone:s.customerPhone||"",customerDocument:s.customerDocument||"",dailyRate:s.dailyRate,contractDays:s.contractDays,startDate:s.startDate,notes:s.notes||"",devicePin:"",freeDaysLimit:s.freeDaysLimit||4}),x(!0)},B=async s=>{s.preventDefault(),v(!0);try{const a=i?await W(i.contractId,t):await X(t);a.success?(x(!1),D(),d(i?"Â¡Contrato actualizado exitosamente!":"Â¡Contrato creado exitosamente!","success")):d(`Error: ${a.error}`,"error")}catch(a){console.error("Error saving contract:",a),d("Error al guardar contrato","error")}finally{v(!1)}},k=async(s,a)=>{if(confirm(`Â¿EstÃ¡ seguro de cambiar el estado a ${a}?`))try{const r=await J(s,a);r.success?(D(),d("Â¡Estado actualizado exitosamente!","success")):d(`Error: ${r.error}`,"error")}catch(r){console.error("Error updating status:",r),d("Error al actualizar estado","error")}},f=s=>`$${s.toLocaleString()} COP`,b=s=>({ACTIVE:"#00C292",COMPLETED:"#03C9D7",CANCELLED:"#EF4444",SUSPENDED:"#FB9678"})[s]||"#6B7280",L=h.filter(s=>{var a,r;if(c!=="all"&&s.status.toLowerCase()!==c.toLowerCase())return!1;if(g){const n=g.toLowerCase();return s.deviceId.toLowerCase().includes(n)||s.contractId.toLowerCase().includes(n)||((a=s.customerName)==null?void 0:a.toLowerCase().includes(n))||((r=s.customerEmail)==null?void 0:r.toLowerCase().includes(n))}return!0}),C=({title:s,value:a,icon:r,color:n})=>e.jsxs("div",{className:"contract-stat-card",children:[e.jsx("div",{className:"stat-icon",style:{background:n},children:e.jsx(r,{size:20})}),e.jsxs("div",{className:"stat-info",children:[e.jsx("div",{className:"stat-label",children:s}),e.jsx("div",{className:"stat-number",children:a})]})]});return e.jsxs("div",{className:"contracts-page",children:[e.jsxs("div",{className:"page-header",children:[e.jsxs("div",{children:[e.jsx("h1",{children:"ðŸ“‹ GestiÃ³n de Contratos"}),e.jsx("p",{children:"Gestionar contratos de alquiler de 500 dÃ­as para todos los dispositivos"})]}),e.jsxs("button",{className:"btn-primary",onClick:q,children:[e.jsx(H,{})," Nuevo Contrato"]})]}),e.jsxs("div",{className:"contracts-stats",children:[e.jsx(C,{title:"Total Contratos",value:h.length,icon:T,color:"#03C9D7"}),e.jsx(C,{title:"Activos",value:h.filter(s=>s.status==="ACTIVE").length,icon:K,color:"#00C292"}),e.jsx(C,{title:"Completados",value:h.filter(s=>s.status==="COMPLETED").length,icon:E,color:"#7460EE"}),e.jsx(C,{title:"Valor Total",value:f(h.reduce((s,a)=>s+a.totalAmount,0)),icon:Y,color:"#FB9678"})]}),e.jsxs("div",{className:"contracts-filters",children:[e.jsx("button",{className:`filter-btn ${c==="all"?"active":""}`,onClick:()=>j("all"),children:"Todos"}),e.jsx("button",{className:`filter-btn ${c==="active"?"active":""}`,onClick:()=>j("active"),children:"Activos"}),e.jsx("button",{className:`filter-btn ${c==="completed"?"active":""}`,onClick:()=>j("completed"),children:"Completados"}),e.jsx("button",{className:`filter-btn ${c==="cancelled"?"active":""}`,onClick:()=>j("cancelled"),children:"Cancelados"}),e.jsxs("div",{className:"search-box",children:[e.jsx(Z,{className:"search-icon"}),e.jsx("input",{type:"text",placeholder:"Buscar por ID, nombre o email...",value:g,onChange:s=>I(s.target.value)}),g&&e.jsx("button",{className:"clear-search",onClick:()=>I(""),"aria-label":"Clear search",children:e.jsx(F,{})})]})]}),e.jsx("div",{className:"contracts-list",children:y?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Cargando contratos..."})]}):L.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx(T,{size:48}),e.jsx("h3",{children:"No se encontraron contratos"}),e.jsx("p",{children:"Cree un nuevo contrato para comenzar"})]}):L.map(s=>e.jsx("div",{className:"contract-card",children:e.jsxs("div",{className:"contract-body",onClick:a=>{a.stopPropagation(),S(s),m(null)},children:[e.jsxs("div",{className:"contract-info-grid",children:[e.jsxs("div",{className:"contract-title",children:[e.jsx("h3",{children:s.deviceIdName||s.deviceId}),e.jsx("a",{onClick:a=>{a.stopPropagation()},href:`/p/${s.deviceIdName||s.deviceId}`,target:"_blank",rel:"noopener noreferrer",className:"text-gray-900 hover:text-indigo-600 transition-colors",title:"Open Payment Page",children:e.jsx("span",{className:"status-badge",style:{background:`${b(s.status)}20`,color:b(s.status)},children:s.status})})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:"Cliente"}),e.jsx("span",{className:"info-value",children:s.customerName||"N/A"})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:"Tarifa Diaria"}),e.jsx("span",{className:"info-value",children:f(s.dailyRate)})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:"DÃ­as Totales"}),e.jsxs("span",{className:"info-value",children:[s.contractDays," dÃ­as"]})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:"Monto Total"}),e.jsx("span",{className:"info-value",children:f(s.totalAmount)})]}),e.jsx("div",{className:"info-item action-menu-wrapper",children:e.jsxs("div",{className:"action-menu-container",children:[e.jsx("button",{className:`action-menu-btn ${p===s.contractId?"active":""}`,onClick:a=>{a.stopPropagation(),m(p===s.contractId?null:s.contractId)},children:e.jsx(re,{size:20})}),p===s.contractId&&e.jsxs("div",{className:"action-menu-dropdown",children:[e.jsxs("button",{onClick:()=>{S(s),m(null)},children:[e.jsx(se,{size:16})," Editar"]}),s.status==="ACTIVE"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{k(s.contractId,"COMPLETED"),m(null)},children:[e.jsx(E,{size:16})," Completar"]}),e.jsxs("button",{className:"text-danger",onClick:()=>{k(s.contractId,"CANCELLED"),m(null)},children:[e.jsx(F,{size:16})," Cancelar"]})]})]})]})})]}),e.jsxs("div",{className:"contract-progress",children:[e.jsxs("div",{className:"progress-header",children:[e.jsxs("span",{children:["Progreso: ",s.paidDays," / ",s.contractDays," dÃ­as"]}),e.jsxs("span",{className:"progress-percent",children:[(s.paidDays/s.contractDays*100).toFixed(1),"%"]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${s.paidDays/s.contractDays*100}%`,background:b(s.status)}})}),e.jsxs("div",{className:"progress-details",children:[e.jsxs("div",{children:[e.jsx(E,{size:14}),"Pagado: ",f(s.paidAmount)]}),e.jsxs("div",{children:[e.jsx(ae,{size:14}),s.startDate," â†’ ",s.endDate]})]})]})]})},s.contractId))}),z&&e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal-content",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:i?"Editar Contrato":"Nuevo Contrato"}),e.jsx("button",{className:"modal-close",onClick:()=>x(!1),children:"Ã—"})]}),e.jsxs("form",{onSubmit:B,className:"contract-form",children:[e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"ID Dispositivo *"}),i?e.jsx("input",{type:"text",value:t.deviceId,disabled:!0}):e.jsxs(e.Fragment,{children:[e.jsxs("select",{value:t.deviceId,onChange:s=>{var w;const a=s.target.value;console.log(a),console.log(N);const r=N.find(G=>G.deviceId===a*1);console.log(r);const n=((w=u==null?void 0:u.contractDefaults)==null?void 0:w.emailDomain)||"pocketbike.app",V=r&&r.name?`${r.name.trim()}@${n}`.toLowerCase():"";l({...t,deviceId:a,customerEmail:V})},required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar dispositivo..."}),N.filter(s=>!s.hasActiveContract).map(s=>e.jsx("option",{value:s.deviceId,children:s.name||""},s.deviceId))]}),e.jsx("small",{style:{color:"#6B7280",fontSize:"0.813rem",marginTop:"0.25rem",display:"block"},children:"Cada dispositivo solo puede tener un contrato activo. Cancele los contratos existentes antes de crear uno nuevo."})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Fecha Inicio *"}),e.jsx("input",{type:"date",value:t.startDate,onChange:s=>l({...t,startDate:s.target.value}),required:!0,disabled:i})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"TelÃ©fono del Cliente"}),e.jsx("input",{type:"tel",value:t.customerPhone,onChange:s=>{const a=s.target.value.replace(/\D/g,"").slice(0,10);let r=a;a.length>6?r=`${a.slice(0,3)} ${a.slice(3,6)} ${a.slice(6)}`:a.length>3&&(r=`${a.slice(0,3)} ${a.slice(3)}`),l({...t,customerPhone:r})},maxLength:"12",placeholder:"300 000 0000"})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["PIN del Dispositivo ",i?"(Dejar vacÃ­o para mantener el actual)":"*"]}),e.jsx("input",{type:"text",value:t.devicePin,onChange:s=>l({...t,devicePin:s.target.value}),placeholder:"PIN de 4 dÃ­gitos",maxLength:"4",className:"font-mono",required:!i}),e.jsxs("div",{style:{marginTop:"0.5rem",display:"flex",alignItems:"center"},children:[e.jsx("input",{type:"checkbox",id:"usePhonePin",style:{marginRight:"0.5rem",width:"auto"},onChange:s=>{if(s.target.checked){const r=(t.customerPhone||"").replace(/\D/g,"");r.length>=4?l(n=>({...n,devicePin:r.slice(-4)})):(d("Ingrese un nÃºmero de celular vÃ¡lido primero","error"),s.target.checked=!1)}}}),e.jsx("label",{htmlFor:"usePhonePin",style:{fontSize:"0.9rem",color:"#4B5563",cursor:"pointer"},children:"Usa los Ãºltimos 4 del celular"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Nombre del Cliente"}),e.jsx("input",{type:"text",value:t.customerName,onChange:s=>l({...t,customerName:s.target.value}),placeholder:"John Doe"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Email del Cliente"}),e.jsx("input",{type:"email",value:t.customerEmail,onChange:s=>l({...t,customerEmail:s.target.value}),placeholder:"cliente@email.com"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Documento del Cliente"}),e.jsx("input",{type:"text",value:t.customerDocument,onChange:s=>l({...t,customerDocument:s.target.value}),placeholder:"CÃ©dula/NIT"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Tarifa Diaria (COP)"}),e.jsx("input",{type:"text",value:new Intl.NumberFormat("es-CO",{style:"currency",currency:"COP",minimumFractionDigits:0}).format(t.dailyRate),onChange:s=>{const a=parseInt(s.target.value.replace(/\D/g,""),10)||0;l({...t,dailyRate:a})},placeholder:"$ 30.000"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"DÃ­as de Contrato"}),e.jsx("input",{type:"number",value:t.contractDays,onChange:s=>l({...t,contractDays:parseInt(s.target.value)}),min:"1",max:"1000"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Cuota Inicial (COP)"}),e.jsx("input",{type:"text",value:new Intl.NumberFormat("es-CO",{style:"currency",currency:"COP",minimumFractionDigits:0}).format(t.initialFee),onChange:s=>{const a=parseInt(s.target.value.replace(/\D/g,""),10)||0;l({...t,initialFee:a})},placeholder:"$ 0",disabled:i})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"DÃ­as Libres al Mes"}),e.jsx("input",{type:"number",value:t.freeDaysLimit,onChange:s=>l({...t,freeDaysLimit:parseInt(s.target.value)}),min:"0",max:"31"})]})]}),e.jsxs("div",{className:"form-group full-width",children:[e.jsx("label",{children:"Notas"}),e.jsx("textarea",{value:t.notes,onChange:s=>l({...t,notes:s.target.value}),rows:"3",placeholder:"Notas adicionales..."})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:()=>x(!1),children:"Cancelar"}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:y,children:y?"Guardando...":i?"Actualizar Contrato":"Crear Contrato"})]})]})]})})]})};export{je as default};
